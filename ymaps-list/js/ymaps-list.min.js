"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,s){for(var e=0;e<s.length;e++){var o=s[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(s,e,o){return e&&t(s.prototype,e),o&&t(s,o),s}}();function _classCallCheck(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}var Ylist=function(){function t(s){_classCallCheck(this,t),this.options=s,this.map=null,s.hasOwnProperty("data")?this.points=this.options.data:this.points=null,this.placemarks=[],this.activePlacemark=null,this.activeListItem=null,this.clusterer=null,this.balloonLayout=null,this.ballonParams={balloonWidth:null,balloonHeight:null,balloonTailHeight:15},this.listClassName="ylist-list",this.isLessThanAdaptiveBreakpoint=!1,this.mqlAdaptiveBreakpoint=window.matchMedia("(max-width: "+(this.options.adaptiveBreakpoint-1)+"px)"),this.needReloadMap=!0}return _createClass(t,[{key:"init",value:function(){this._checkRequiredOptions();var t=this;ymaps.ready(function(){t.mqlAdaptiveBreakpoint.addListener(function(){t._adaptiveHandle(this,t)}),t._adaptiveHandle(t.mqlAdaptiveBreakpoint,t)}),this.options.list&&this._initList()}},{key:"_checkRequiredOptions",value:function(){this.points?!this.options.hasOwnProperty("dataOrder")||this.options.hasOwnProperty("dataOrder")&&0==this.options.dataOrder.length?console.log("You need to set dataOrder option"):this.options.hasOwnProperty("container")?this.options.hasOwnProperty("mapCenter")?this.options.hasOwnProperty("mapContainer")?(this.options.hasOwnProperty("list")||(this.options.list=!1),this.options.hasOwnProperty("list")&&this.options.list&&!this.options.hasOwnProperty("listContainer")?console.log("You need to set listContainer option"):(this.options.hasOwnProperty("listScroll")||(this.options.listScroll=!1),this.options.hasOwnProperty("switchContainer")||(this.options.switchContainer=!1),this.options.hasOwnProperty("cluster")||(this.options.cluster={}),this.options.hasOwnProperty("cluster")&&"object"==_typeof(this.options.cluster)&&!this.options.cluster.hasOwnProperty("icons")&&(this.options.cluster.icons=["islands#invertedRedClusterIcons","islands#invertedBlueClusterIcons"]),this.options.hasOwnProperty("cluster")&&"object"==_typeof(this.options.cluster)&&!this.options.cluster.hasOwnProperty("inlineStyle")&&(this.options.cluster.inlineStyle=""),this.options.hasOwnProperty("balloonBeforeBreakpoint")||(this.options.balloonBeforeBreakpoint=!1),this.options.hasOwnProperty("balloonAfterBreakpoint")||(this.options.balloonAfterBreakpoint=!1),this.options.hasOwnProperty("adaptiveBreakpoint")||(this.options.adaptiveBreakpoint=1024),this.options.hasOwnProperty("placemark")||(this.options.placemark={}),this.options.hasOwnProperty("placemark")&&"object"==_typeof(this.options.placemark)&&!this.options.placemark.hasOwnProperty("icons")&&(this.options.placemark.icons=["islands#redDotIcon","islands#blueDotIcon"]),this.options.hasOwnProperty("placemark")&&"object"==_typeof(this.options.placemark)&&!this.options.placemark.hasOwnProperty("clicked")&&(this.options.placemark.clicked=!0))):console.log("You need to set mapContainer option"):console.log("You need to set mapCenter option"):console.log("You need to set container option"):console.log("You need to JSON data")}},{key:"_initMap",value:function(){this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null),this.map=new ymaps.Map(this.options.mapContainer,{center:this.options.mapCenter,zoom:13,controls:[]});var t=new ymaps.control.ZoomControl({options:{size:"small",position:{top:10,right:10}}});this.map.controls.add(t),this.map.behaviors.disable("scrollZoom"),this._createPlacemarks(),"boolean"!=typeof this.options.cluster||this.options.cluster?(this._createClusterer(),this._addClusterer(),this._setBounds(this.clusterer)):(this._addPlacemarks(),this._setBounds(this.map.geoObjects)),this.isLessThanAdaptiveBreakpoint&&this.map.behaviors.disable("drag"),this.needReloadMap=!1}},{key:"_destroyMap",value:function(){this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null)}},{key:"_initList",value:function(){this._createPointsList()}},{key:"_createPlacemarks",value:function(){for(var t=this,s=0;s<this.points.length;s++){var e=void 0;e=this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&this.options.placemark.clicked||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked?this._setBalloonData(s):{};var o=this.points[s],i=new ymaps.Placemark(o.coords,e,this._setPlacemarkOptions(s));i.id=o.id,i.events.add("click",function(s){t._placemarkClickHandler(s,t)}),this.activeListItem&&this.activeListItem==o.id&&("string"==typeof this.options.placemark.icons[0]?i.options.set("preset",this.options.placemark.icons[1]):i.options.set("iconImageHref",this.options.placemark.icons[1].href),i.isActive=!0),this.placemarks.push(i)}}},{key:"_addPlacemarks",value:function(){for(var t=0;t<this.placemarks.length;t++)this.map.geoObjects.add(this.placemarks[t])}},{key:"_setPlacemarkOptions",value:function(t){var s={};return"string"==typeof this.options.placemark.icons[0]?s.preset=this.options.placemark.icons[0]:(s.iconLayout="default#image",s.iconImageHref=this.options.placemark.icons[0].href,s.iconImageSize=this.options.placemark.icons[0].size,s.iconImageOffset=this.options.placemark.icons[0].offset),(this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&this.options.placemark.clicked||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked)&&(s.balloonLayout=this._createBalloonLayout(),s.balloonContentLayout=this._createBalloonContentLayout(),s.balloonAutoPan=!1,s.balloonShadow=!1,s.balloonPanelMaxMapArea=0),this.options.placemark.clicked||(s.cursor="default"),s}},{key:"_createClusterer",value:function(){if(this.clusterer&&this.clusterer.removeAll(),this.clusterer=new ymaps.Clusterer({groupByCoordinates:!1,clusterDisableClickZoom:!1,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,zoomMargin:40}),"string"==typeof this.options.cluster.icons[0])this.clusterer.options.set({preset:this.options.cluster.icons[0]});else{var t=ymaps.templateLayoutFactory.createClass('<div style="'+this.options.cluster.inlineStyle+'">{{ properties.geoObjects.length }}</div>');this.clusterer.options.set({clusterIcons:this.options.cluster.icons[0],clusterNumbers:[100],clusterIconContentLayout:t})}this.clusterer.add(this.placemarks)}},{key:"_addClusterer",value:function(){this.map.geoObjects.add(this.clusterer)}},{key:"_createBalloonLayout",value:function(){var t=this;return ymaps.templateLayoutFactory.createClass('<div class="ylist-balloon">\n                <button class="ylist-balloon__close" type="button">x</button>\n                <div class="ylist-balloon__inner">\n                    $[[options.contentLayout]]\n                </div>\n            </div>',{build:function(){this.constructor.superclass.build.call(this),this._$element=$(".ylist-balloon",this.getParentElement()),this.applyElementOffset(),this._$element.find(".ylist-balloon__close").on("click",$.proxy(this.onCloseClick,this)),t.ballonParams.balloonWidth=this._$element[0].offsetWidth,t.ballonParams.balloonHeight=this._$element[0].offsetHeight+t.ballonParams.balloonTailHeight},clear:function(){this._$element.find(".ylist-balloon__close").off("click"),this.constructor.superclass.clear.call(this)},onSublayoutSizeChange:function(){this.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments),this._isElement(this._$element)&&(this.applyElementOffset(),this.events.fire("shapechange"))},applyElementOffset:function(){this._$element.css({left:-this._$element[0].offsetWidth/2,top:-(this._$element[0].offsetHeight+t.ballonParams.balloonTailHeight)})},onCloseClick:function(t){t.preventDefault(),this.events.fire("userclose")},_isElement:function(t){return t&&t[0]&&t.find(".ylist-balloon__inner")[0]}})}},{key:"_createBalloonContentLayout",value:function(){return ymaps.templateLayoutFactory.createClass('<h3 class="ylist-balloon__title">$[properties.balloonHeader]</h3>\n            <div class="ylist-balloon__content">$[properties.balloonContent]</div>')}},{key:"_setBalloonData",value:function(t){for(var s="",e=0;e<this.options.dataOrder.length;e++){var o=this.options.dataOrder[e];s+='<p class="ylist-balloon__'+o+'">'+this.points[t][o]+"</p>"}return{balloonHeader:this.points[t].name,balloonContent:s}}},{key:"_createListElement",value:function(t){var s=$("<h3/>",{class:this.listClassName+"__title"}),e="",o=$("<li/>",{id:t.id,class:this.listClassName+"__item"});"string"==typeof t.name?s.html("<a>"+t.name+"</a>"):s=null;for(var i=0;i<this.options.dataOrder.length;i++){var a=this.options.dataOrder[i];e+='<p class="'+this.listClassName+"__"+a+'">'+t[a]+"</p>"}return o.append(s,e),o}},{key:"_createPointsList",value:function(){for(var t=this,s=$("<ul/>",{class:this.listClassName}),e=0;e<this.points.length;e++){var o=this.points[e];s.append(this._createListElement(o))}$("#"+this.options.listContainer).html("").append(s),$(document).on("click","."+t.listClassName+"__title",function(s){var e=$(this).closest("."+t.listClassName+"__item").attr("id");if(t.placemarks.length>0)for(var o=0;o<t.placemarks.length;o++){var i=t.placemarks[o];if(i.id==e){t._listItemClickHandler(s,i);break}}else t._listItemClickHandler(s,e)})}},{key:"_setBounds",value:function(t){this.map.setBounds(t.getBounds(),{checkZoomRange:!0,zoomMargin:10})}},{key:"_placemarkClickHandler",value:function(t,s){if(this.options.placemark.clicked){var e=t.get("target");if(s.activePlacemark=e,this._commonClickHandler(e),this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint){s.map.geoObjects.events.add("balloonopen",function t(){var o,i=void 0;(i=s.map.options.get("projection").toGlobalPixels(e.geometry.getCoordinates(),s.map.getZoom()))[1]-=s.ballonParams.balloonHeight/2,o=s.map.options.get("projection").fromGlobalPixels(i,s.map.getZoom()),s.map.panTo(o,{flying:!0}),s.map.geoObjects.events.remove("balloonopen",t)})}else s.map.panTo(e.geometry.getCoordinates(),{flying:!0})}}},{key:"_listItemClickHandler",value:function(t,s){if(this._commonClickHandler(s),"string"!=typeof s){if(this.activePlacemark&&this.map.getZoom()<11){var e=this.clusterer.getObjectState(this.activePlacemark).isClustered,o=this.clusterer.getObjectState(s).isClustered;if(!e&&!o)return this.map.panTo(s.geometry.getCoordinates(),{flying:!0}),void(this.activePlacemark=s)}for(var i=9===this.map.getZoom()?this.map.getZoom():9;this.map.setCenter(s.geometry.getCoordinates(),i++),this.clusterer.getObjectState(s).isClustered;);this.activePlacemark=s}}},{key:"_commonClickHandler",value:function(t){var s=null,e=null,o=null;if(this.options.list&&(s=$("#"+this.options.listContainer)),"string"==typeof t)this.options.list&&(e=$("#"+t)),o=t;else{this.options.list&&(e=$("#"+t.id)),o=t.id;for(var i=0;i<this.placemarks.length;i++){var a=this.placemarks[i];"string"==typeof this.options.placemark.icons[0]?a.options.set("preset",this.options.placemark.icons[0]):a.options.set("iconImageHref",this.options.placemark.icons[0].href),a.balloon.close(),this.clusterer.getObjectState(a).cluster&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(a).cluster.options.set("preset",this.options.cluster.icons[0]):this.clusterer.getObjectState(a).cluster.options.set("clusterIcons",this.options.cluster.icons[0])),a.isActive=!1}this.clusterer.getObjectState(t).isClustered&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(t).cluster.options.set("preset",this.options.cluster.icons[1]):this.clusterer.getObjectState(t).cluster.options.set("clusterIcons",this.options.cluster.icons[1])),"string"==typeof this.options.placemark.icons[0]?t.options.set("preset",this.options.placemark.icons[1]):t.options.set("iconImageHref",this.options.placemark.icons[1].href),t.isActive=!0}this.activeListItem=o,this.options.list&&(s.find(".is-active").removeClass("is-active"),e.addClass("is-active"),"boolean"!=typeof this.options.listScroll||this.options.listScroll?this.options.listScroll(s,e):s.scrollTop(e.position().top+s.scrollTop()))}},{key:"_adaptiveHandle",value:function(t,s){t.matches?(s.isLessThanAdaptiveBreakpoint=!0,s.needReloadMap=!0,s.options.list&&s._destroyMap(),0!=s.options.switchContainer&&($("#"+s.options.switchContainer).addClass("is-visible"),$("#"+s.options.switchContainer).find('[data-ylist-switch="list"]').addClass("is-active")),s.options.list&&$("#"+s.options.mapContainer).addClass("is-hidden"),$("#"+s.options.mapContainer).addClass("is-adaptive"),$("#"+s.options.listContainer).addClass("is-adaptive"),$("#"+s.options.container).addClass("is-adaptive"),s.options.list||s.map||s._initMap(),$(document).on("click","[data-ylist-switch]",function(t){s._switchHandler(t,s)})):(s.isLessThanAdaptiveBreakpoint=!1,0!=s.options.switchContainer&&($("#"+s.options.switchContainer).removeClass("is-visible"),$("#"+s.options.switchContainer).find("[data-ylist-switch]").removeClass("is-active")),$("#"+s.options.mapContainer).removeClass("is-adaptive is-hidden"),$("#"+s.options.listContainer).removeClass("is-adaptive is-hidden"),$("#"+s.options.container).removeClass("is-adaptive"),!s.options.list&&(s.options.list||s.isLessThanAdaptiveBreakpoint||s.map)||s._initMap(),$(document).off("click","[data-ylist-switch]",s._switchHandler))}},{key:"_switchHandler",value:function(t,s){var e=$(t.target);e.length&&!e.hasClass("is-active")&&("map"===e.attr("data-ylist-switch")?($("#"+s.options.mapContainer).removeClass("is-hidden"),$("#"+s.options.listContainer).addClass("is-hidden"),s.needReloadMap&&s._initMap()):"list"===e.attr("data-ylist-switch")&&($("#"+s.options.mapContainer).addClass("is-hidden"),$("#"+s.options.listContainer).removeClass("is-hidden")),$("[data-ylist-switch]").removeClass("is-active"),e.addClass("is-active"))}}]),t}();